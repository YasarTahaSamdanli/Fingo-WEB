<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingo Web Uygulaması</title>
    <!-- Kendi derlenmiş Tailwind CSS dosyamızı bağlıyoruz -->
    <link href="output.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome Icons (örneğin menü ikonu için) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Mesaj kutusu için kritik CSS - Lütfen bu blokun doğru olduğundan emin olun! */
        .message-box {
            position: fixed; /* Sabit konumlandırma */
            top: 20px;       /* Üstten 20px boşluk */
            right: 20px;     /* Sağdan 20px boşluk */
            background-color: #4CAF50; /* Varsayılan başarı rengi */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000; /* Diğer her şeyin üzerinde olması için yüksek z-index */
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 250px;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message-box.error {
            background-color: #f44336; /* Kırmızı */
        }
        .message-box.warning {
            background-color: #ff9800; /* Turuncu */
        }
        .message-box.info {
            background-color: #2196f3; /* Mavi */
        }
        .message-box.confirm {
            background-color: #607D8B; /* Gri */
            min-width: 300px;
            flex-direction: column; /* Butonları alt alta sırala */
            align-items: center;
        }
        .message-box-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
        }
        .message-box.confirm .message-box-close {
            position: absolute;
            top: 5px;
            right: 10px;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100 font-sans overflow-x-hidden">

    <!-- Header - Başlık ve Kullanıcı Bilgisi/Çıkış -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-40 relative">
        <div class="flex items-center">
            <!-- Menü Aç/Kapa Butonu (Artık her zaman görünür) -->
            <button id="sidebarToggleBtn" class="p-2 rounded-md hover:bg-gray-200 mr-4">
                <i class="fas fa-bars text-gray-700 text-xl"></i>
            </button>
            <h1 class="text-2xl md:text-3xl font-bold text-blue-700">Fingo Finans Takip</h1>
        </div>
        <div class="flex items-center space-x-3 md:space-x-4">
            <span id="loggedInUser" class="text-gray-700 text-sm md:text-base font-medium hidden md:block"></span>
            <button id="manageProfileBtn" class="bg-gray-600 text-white px-3 py-1 md:px-4 md:py-2 rounded-md hover:bg-gray-700 transition-colors text-xs md:text-sm">Profil Yönetimi</button>
            <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 md:px-4 md:py-2 rounded-md hover:bg-red-600 transition-colors text-xs md:text-sm">Çıkış Yap</button>
        </div>
    </header>

    <!-- Ana İçerik Alanı -->
    <div class="flex flex-1 relative">

        <!-- Yan Menü (Sidebar) -->
        <!-- Varsayılan olarak kapalı (-translate-x-full) başlar, JS ile açılır -->
        <aside id="sidebar" class="fixed top-0 left-0 h-full bg-blue-800 text-white w-64 p-4 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out shadow-lg pt-20 lg:pt-4">
            <!-- Kapatma Butonu (Artık her zaman görünür) -->
            <button id="closeSidebarBtn" class="absolute top-4 right-4 p-2 rounded-md hover:bg-blue-700 text-white text-2xl">
                &times; <!-- Kapatma ikonu -->
            </button>
            <h2 class="text-xl font-semibold mb-6">Yönetim Paneli</h2>
            <nav class="space-y-3">
                <!-- Ürün Yönetimi Butonu -->
                <button id="manageProductsBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-box"></i> <span>Ürün Yönetimi</span>
                </button>
                <!-- Satış Yönetimi (YENİ EKLENDİ) -->
                <button id="goToSalesManagementBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-shopping-cart"></i><span>Satış Yönetimi</span>
                </button>

                <!-- Tekrarlayan İşlemleri Yönet Butonu -->
                <button id="manageRecurringTransactionsBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-redo"></i> <span>Tekrarlayan İşlemler</span>
                </button>
                <!-- Raporları Görüntüle Butonu -->
                <button id="viewReportsBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-chart-line"></i> <span>Raporları Görüntüle</span>
                </button>
                <!-- Verileri Dışa Aktar (CSV) Butonu -->
                <button id="exportCsvBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-file-export"></i> <span>Verileri Dışa Aktar (CSV)</span>
                </button>
                <!-- Verileri İçe Aktar (CSV) Butonu -->
                <button id="importCsvBtn" class="w-full text-left p-3 rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-3 text-lg">
                    <i class="fas fa-file-import"></i> <span>Verileri İçe Aktar (CSV)</span>
                </button>
            </nav>
        </aside>

        <!-- Sidebar Overlay (Menü açıkken arkadaki içeriği karartır - Mobil ve PC'de aktif) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- Dashboard Ana İçerik Alanı -->
        <!-- lg:ml-64 dinamik olarak JS ile eklenip çıkarılacak -->
        <main id="mainContent" class="flex-1 p-4 md:p-6 lg:p-8 mt-4 mb-4 bg-white rounded-lg shadow-xl border border-gray-200 w-full max-w-7xl mx-auto">
            <!-- Genel Bilgi Mesajı -->
            <p class="text-sm text-gray-600 text-center mb-8">Finansal işlemlerinizi kolayca yönetin ve takip edin. (v1.5.8)</p>

            <!-- Ana İçerik Alanı - Grid Sistemi -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Sol Sütun (İşlem Ekleme/Güncelleme Formu) -->
                <div class="lg:col-span-1">
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200 shadow-md h-full flex flex-col">
                        <h2 id="formTitle" class="text-xl font-semibold text-blue-600 mb-4 text-center">Yeni İşlem Ekle</h2>
                        <div class="grid grid-cols-1 gap-3 mb-3">
                            <div>
                                <label for="transactionType" class="block text-gray-700 text-sm font-medium mb-1">İşlem Tipi:</label>
                                <select id="transactionType" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="Gider">Gider</option>
                                    <option value="Gelir">Gelir</option>
                                </select>
                            </div>
                            <div>
                                <label for="amount" class="block text-gray-700 text-sm font-medium mb-1">Miktar (₺):</label>
                                <input type="number" id="amount" placeholder="Örn: 150.75" step="0.01" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="description" class="block text-gray-700 text-sm font-medium mb-1">Açıklama:</label>
                                <input type="text" id="description" placeholder="Örn: Market alışverişi" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="categorySelect" class="block text-gray-700 text-sm font-medium mb-1">Kategori:</label>
                                <select id="categorySelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="">Kategori Seçin (Opsiyonel)</option>
                                </select>
                            </div>
                            <div>
                                <label for="transactionDate" class="block text-gray-700 text-sm font-medium mb-1">Tarih:</label>
                                <input type="date" id="transactionDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button id="submitTransactionBtn" class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors text-sm">İşlem Ekle</button>
                            <button id="cancelEditBtn" class="flex-1 bg-gray-400 text-white p-2 rounded-md hover:bg-gray-500 transition-colors hidden text-sm">İptal</button>
                        </div>
                        <!-- Kategori Yönetimi Formu Buraya Taşındı -->
                        <div class="mt-6 pt-4 border-t border-blue-200">
                            <h3 id="categoryFormTitle" class="text-lg font-semibold text-blue-600 mb-3 text-center">Kategori Oluştur / Düzenle</h3>
                            <div class="flex flex-col sm:flex-row gap-3 mb-3">
                                <input type="text" id="addCategoryInput" placeholder="Kategori Adı" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <select id="addCategoryTypeSelect" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Genel">Genel</option>
                                    <option value="Gelir">Gelir</option>
                                    <option value="Gider">Gider</option>
                                </select>
                            </div>
                            <div class="flex space-x-2 mb-4">
                                <button id="submitCategoryBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm whitespace-nowrap">Kaydet</button>
                                <button id="cancelCategoryEditBtn" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition-colors text-sm whitespace-nowrap hidden">İptal</button>
                            </div>

                            <h3 class="text-lg font-semibold text-blue-600 mb-3 text-center">Mevcut Kategoriler</h3>
                            <div class="max-h-40 overflow-y-auto p-2 bg-white rounded-md border border-gray-100 shadow-sm">
                                <ul id="categoriesListInForm" class="space-y-2">
                                    <li class="text-center text-gray-500 text-sm">Kategori yok.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div> <!-- Sol Sütun Bitişi -->

                <!-- Sağ Sütun (Filtreler ve İşlem Listesi) -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- Filtreleme Formu -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200 shadow-md">
                        <h2 class="text-xl font-semibold text-purple-600 mb-4 text-center">İşlemleri Filtrele</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label for="filterType" class="block text-gray-700 text-sm font-medium mb-1">İşlem Tipi:</label>
                                <select id="filterType" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                                    <option value="">Tümü</option>
                                    <option value="Gider">Gider</option>
                                    <option value="Gelir">Gelir</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterCategory" class="block text-gray-700 text-sm font-medium mb-1">Kategori:</label>
                                <input type="text" id="filterCategory" placeholder="Kategoriye göre ara" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="filterDescription" class="block text-gray-700 text-sm font-medium mb-1">Açıklama Ara:</label>
                                <input type="text" id="filterDescription" placeholder="Açıklama içinde ara" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            </div>
                            <div>
                                <label for="filterStartDate" class="block text-gray-700 text-sm font-medium mb-1">Başlangıç Tarihi:</label>
                                <input type="date" id="filterStartDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            </div>
                            <div>
                                <label for="filterEndDate" class="block text-gray-700 text-sm font-medium mb-1">Bitiş Tarihi:</label>
                                <input type="date" id="filterEndDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button id="applyFilterBtn" class="flex-1 bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700 transition-colors text-sm">Filtrele</button>
                            <button id="clearFilterBtn" class="flex-1 bg-gray-400 text-white p-2 rounded-md hover:bg-gray-500 transition-colors text-sm">Filtreleri Temizle</button>
                        </div>
                    </div>

                    <!-- İşlemler Listesi -->
                    <div id="transactionsListContainer" class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-md relative">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">İşlemleriniz</h2>
                        <div id="transactionsList" class="space-y-3 max-h-[400px] overflow-y-auto">
                            <!-- İşlemler buraya JS ile yüklenecek -->
                        </div>
                        <!-- Yükleme Overlay'i -->
                        <div id="transactionsLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden rounded-lg">
                            <p class="text-center text-gray-700 text-lg">
                                <span class="inline-block h-6 w-6 border-4 border-t-4 border-gray-400 rounded-full animate-spin mr-3"></span>
                                Yükleniyor...
                            </p>
                        </div>
                        <p class="text-right text-lg font-bold text-gray-800 mt-4">Genel Bakiye: <span id="balance">0.00 TL</span></p>
                    </div>

                </div> <!-- Sağ Sütun Bitişi -->

            </div> <!-- Ana İçerik Alanı Bitişi -->

            <!-- Aylık ve Yıllık Özet Grafikleri -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Aylık Özet Grafiği -->
                <div class="p-6 bg-yellow-50 rounded-lg border border-yellow-200 shadow-md">
                    <h2 class="text-xl font-semibold text-yellow-700 mb-4 text-center">Aylık Finansal Özet</h2>
                    <div class="flex justify-center items-center mb-4 space-x-2">
                        <label for="monthSelect" class="text-gray-700 text-sm font-medium">Ay:</label>
                        <select id="monthSelect" class="p-1 border border-gray-300 rounded-md text-sm"></select>
                        <label for="yearSelect" class="text-gray-700 text-sm font-medium">Yıl:</label>
                        <select id="yearSelect" class="p-1 border border-gray-300 rounded-md text-sm"></select>
                        <button id="applyMonthlySummaryFilterBtn" class="bg-yellow-600 text-white px-3 py-1 rounded-md hover:bg-yellow-700 transition-colors text-sm">Uygula</button>
                    </div>
                    <div class="relative h-64">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>
                    <p id="monthlyNetBalance" class="text-center text-lg font-bold text-blue-600 mt-4">Net Bakiye: <span id="monthlyNetBalanceValue">0.00</span> TL</p>
                </div>

                <!-- Yıllık Özet Grafiği -->
                <div class="p-6 bg-indigo-50 rounded-lg border border-indigo-200 shadow-md">
                    <h2 class="text-xl font-semibold text-indigo-700 mb-4 text-center">Yıllık Finansal Özet</h2>
                    <div class="flex justify-center items-center mb-4 space-x-2">
                        <label for="annualYearSelect" class="block text-gray-700 text-sm font-medium">Yıl:</label>
                        <select id="annualYearSelect" class="p-1 border border-gray-300 rounded-md text-sm"></select>
                        <button id="applyAnnualSummaryFilterBtn" class="bg-indigo-600 text-white px-3 py-1 rounded-md hover:bg-indigo-700 transition-colors text-sm">Uygula</button>
                    </div>
                    <div class="relative h-64">
                        <canvas id="annualSummaryChart"></canvas>
                    </div>
                    <p id="annualNetBalance" class="text-center text-lg font-bold text-blue-600 mt-4">Net Bakiye: <span id="annualNetBalanceValue">0.00</span> TL</p>
                </div>
            </div>

            <!-- Genel Finansal Özet Tablosu (En Altta, Tüm Genişliği Kaplayacak) -->
            <div class="mt-6 p-6 bg-green-50 rounded-lg border border-green-200 shadow-md">
                <h2 class="text-xl font-semibold text-green-700 mb-4 text-center">Genel Finansal Özet</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-lg text-gray-600">Toplam Gelir</p>
                        <p id="generalSummaryIncome" class="text-2xl font-bold text-green-600">0.00 TL</p>
                    </div>
                    <div>
                        <p class="text-lg text-gray-600">Toplam Gider</p>
                        <p id="generalSummaryExpense" class="text-2xl font-bold text-red-600">0.00 TL</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-gray-800">Net Bakiye</p>
                        <p id="generalSummaryNetBalance" class="text-2xl font-bold text-blue-600">0.00 TL</p>
                    </div>
                </div>
                <p class="text-center text-sm text-gray-500 mt-4">Bu özet, tüm işlemlerinizi kapsar.</p>
            </div>
        </main>
    </div>

    <!-- Mesaj Kutusu -->
    <div id="messageBox" class="message-box hidden">
        <span id="messageText"></span>
        <button class="message-box-close" onclick="document.getElementById('messageBox').classList.add('hidden');">&times;</button>
    </div>

    <!-- Tekrarlayan İşlemler Modalı -->
    <!-- justify-end: Modalı sağa hizalar -->
    <div id="recurringTransactionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-end p-4 hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg border border-gray-200 relative overflow-y-auto max-h-screen">
            <button id="closeRecurringTransactionsModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">Tekrarlayan İşlemleri Yönet</h2>

            <!-- Vadesi Gelenleri İşle Butonu -->
            <div class="mb-6 text-center">
                <button id="processDueRecurringTransactionsBtn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors shadow-md">Vadesi Gelenleri Şimdi İşle</button>
                <p class="text-xs text-gray-500 mt-2">Bu, vadesi gelmiş tekrarlayan işlemlerden yeni kayıtlar oluşturur.</p>
            </div>

            <!-- Tekrarlayan İşlem Ekleme/Güncelleme Formu -->
            <div class="mb-6 p-4 bg-purple-50 rounded-md border border-purple-200">
                <h3 id="recurringTransactionFormTitle" class="text-lg font-semibold text-purple-600 mb-3">Yeni Tekrarlayan İşlem Ekle</h3>
                <div class="grid grid-cols-1 gap-3 mb-3">
                    <div>
                        <label for="recurringTransactionName" class="block text-gray-700 text-sm font-medium mb-1">Ad:</label>
                        <input type="text" id="recurringTransactionName" placeholder="Örn: Kira, Maaş" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                    </div>
                    <div>
                        <label for="recurringTransactionAmount" class="block text-gray-700 text-sm font-medium mb-1">Miktar (₺):</label>
                        <input type="number" id="recurringTransactionAmount" placeholder="Örn: 5000" step="0.01" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                    </div>
                    <div>
                        <label for="recurringTransactionType" class="block text-gray-700 text-sm font-medium mb-1">İşlem Tipi:</label>
                        <select id="recurringTransactionType" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            <option value="Gider">Gider</option>
                            <option value="Gelir">Gelir</option>
                        </select>
                    </div>
                    <div>
                        <label for="recurringTransactionCategorySelect" class="block text-gray-700 text-sm font-medium mb-1">Kategori:</label>
                        <select id="recurringTransactionCategorySelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            <option value="">Kategori Seçin (Opsiyonel)</option>
                        </select>
                    </div>
                    <div>
                        <label for="recurringTransactionDescription" class="block text-gray-700 text-sm font-medium mb-1">Açıklama (Opsiyonel):</label>
                        <input type="text" id="recurringTransactionDescription" placeholder="Örn: Aylık ev kirası ödemesi" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                    </div>
                    <div>
                        <label for="recurringTransactionStartDate" class="block text-gray-700 text-sm font-medium mb-1">Başlangıç Tarihi:</label>
                        <input type="date" id="recurringTransactionStartDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                    </div>
                    <div>
                        <label for="recurringTransactionFrequency" class="block text-gray-700 text-sm font-medium mb-1">Sıklık:</label>
                        <select id="recurringTransactionFrequency" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm">
                            <option value="daily">Günlük</option>
                            <option value="weekly">Haftalık</option>
                            <option value="monthly">Aylık</option>
                            <option value="yearly">Yıllık</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="recurringTransactionIsActive" class="inline-flex items-center text-gray-700 text-sm font-medium mb-1">
                            <input type="checkbox" id="recurringTransactionIsActive" class="rounded border-gray-300 text-purple-600 shadow-sm focus:ring-purple-500 mr-2"> Aktif
                        </label>
                    </div>
                </div>
                <div class="flex space-x-2 mt-4">
                    <button id="submitRecurringTransactionBtn" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm whitespace-nowrap">Ekle</button>
                    <button id="cancelRecurringTransactionEditBtn" class="flex-1 bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition-colors text-sm whitespace-nowrap hidden">İptal</button>
                </div>
            </div>

            <!-- Tekrarlayan İşlemler Listesi -->
            <div class="p-4 bg-gray-50 rounded-md border border-gray-200 h-64 overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Mevcut Tekrarlayan İşlemler</h3>
                <ul id="recurringTransactionsListInModal" class="space-y-2">
                    <li class="text-center text-gray-500 py-2">Tekrarlayan işlem yok.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Profil Yönetimi Modalı -->
    <div id="profileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-start items-start p-4 hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-200 relative max-h-[90vh] overflow-y-auto">
            <button id="closeProfileModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Profil Yönetimi</h2>

            <div class="mb-4">
                <label for="currentPassword" class="block text-gray-700 text-sm font-medium mb-1">Mevcut Parola:</label>
                <input type="password" id="currentPassword" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Mevcut parolanızı girin">
            </div>
            <div class="mb-6">
                <label for="newPassword" class="block text-gray-700 text-sm font-medium mb-1">Yeni Parola:</label>
                <input type="password" id="newPassword" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Yeni parolanızı girin">
            <p class="text-xs text-gray-500 mt-1">En az 8 karakter, büyük/küçük harf, rakam ve özel karakter (! ^ # @ ? _ = ) ( ) ) içermelidir.</p>
        </div>

            <button id="updatePasswordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors w-full text-sm">Parolayı Güncelle</button>

            <!-- 2FA Yönetim Bölümü -->
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">İki Faktörlü Kimlik Doğrulama (2FA)</h3>
                <div id="twoFASetupArea" class="space-y-4">
                    <p id="twoFAStatus" class="text-center text-gray-600">Durum: Yükleniyor...</p>
                    <button id="toggle2FABtn" class="w-full bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition-colors text-sm hidden">2FA'yı Etkinleştir</button>
                    <div id="recoveryCodesArea" class="hidden">
                        <h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Kurtarma Kodları:</h4>
                        <ul id="recoveryCodesList" class="bg-gray-100 p-3 rounded-md border border-gray-200 grid grid-cols-2 gap-2 text-sm text-gray-800 break-all max-h-40 overflow-y-auto">
                        </ul>
                        <button id="generateNewRecoveryCodesBtn" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors text-sm mt-4">Yeni Kurtarma Kodları Oluştur</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- CSV İçe Aktarma Modalı -->
    <div id="importCsvModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-200 relative">
            <button id="closeImportCsvModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-teal-700 mb-6 text-center">Verileri İçe Aktar (CSV)</h2>

            <div class="mb-4">
                <label for="csvFileInput" class="block text-gray-700 text-sm font-medium mb-1">CSV Dosyası Seçin:</label>
                <input type="file" id="csvFileInput" accept=".csv" class="w-full p-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 text-sm">
                <p class="text-xs text-gray-500 mt-1">Dosya formatı: Tarih (GG.AA.YYYY),Tip (Gelir/Gider),Miktar,Kategori,Açıklama</p>
                <p class="text-xs text-gray-500">Örn: 23.06.2025,Gelir,150.00,Maaş,Haziran Maaşı</p>
                <p class="text-xs text-red-500">Not: Türkçe karakter sorunları için Excel'de CSV'yi içe aktarırken UTF-8 seçtiğinizden emin olun.</p>
            </div>

            <button id="uploadCsvBtn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition-colors w-full text-sm">İçe Aktar</button>

            <div id="importResult" class="mt-4 text-sm max-h-40 overflow-y-auto hidden">
                <p class="font-semibold text-gray-700 mb-2">İçe Aktırma Sonucu:</p>
                <p id="importSummary"></p>
                <ul id="importFailedList" class="list-disc list-inside text-red-600 mt-2"></ul>
            </div>
        </div>
    </div>

    <!-- 2FA Kodu Giriş Modalı -->
    <div id="twoFactorAuthModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-200 relative">
            <button id="closeTwoFactorAuthModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 id="twoFactorAuthModalTitle" class="text-2xl font-bold text-gray-700 mb-6 text-center"></h2>
            <p id="twoFactorAuthMessage" class="text-center text-gray-600 mb-4"></p>

            <div class="mb-4">
                <label for="twoFactorAuthCodeInput" class="block text-gray-700 text-sm font-medium mb-1">Doğrulama Kodu:</label>
                <input type="text" id="twoFactorAuthCodeInput" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="6 haneli kodu girin">
            </div>

            <button id="verifyTwoFactorAuthBtn" data-mode="login" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors w-full text-sm">Kodu Doğrula</button>

            <div class="flex justify-between mt-4">
                <button id="resendTwoFactorAuthCodeBtn" class="text-blue-500 text-sm hover:underline">Kodu Tekrar Gönder</button>
                <button id="useRecoveryCodeBtn" class="text-gray-500 text-sm hover:underline">Kurtarma Kodu Kullan</button>
            </div>
        </div>
    </div>


    <script type="module">
        console.log("Fingo script loading started.");

        import { TwoFactorAuthHandler } from './js/twoFactorAuth.js';

        console.log("TwoFactorAuthHandler imported.");

        const jwtToken = localStorage.getItem('jwtToken');
        const userId = localStorage.getItem('userId');
        const API_BASE_URL = 'https://fingo-web.onrender.com/api';

        // JWT doğrulama ve yönlendirme
        if (!jwtToken || !userId) {
            console.log("JWT veya userId bulunamadı, auth.html'e yönlendiriliyor.");
            window.location.href = 'auth.html';
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("JWT parse edilirken hata:", e);
                return null;
            }
        };

        const decodedToken = parseJwt(jwtToken);
        if (!decodedToken || decodedToken.exp * 1000 < Date.now() || decodedToken.userId !== userId) {
            console.warn("JWT geçersiz veya süresi dolmuş. Giriş sayfasına yönlendiriliyor.");
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            window.location.href = 'auth.html';
        }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Initializing Fingo application elements.");

            // DOM Elementleri Tanımlamaları - Tüm elementleri burada tanımla
            const submitTransactionBtn = document.getElementById('submitTransactionBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const formTitle = document.getElementById('formTitle');
            const transactionTypeSelect = document.getElementById('transactionType');
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');
            const categorySelect = document.getElementById('categorySelect');
            const transactionDateInput = document.getElementById('transactionDate');
            const transactionsListDiv = document.getElementById('transactionsList');
            const transactionsLoadingOverlay = document.getElementById('transactionsLoadingOverlay');
            const balanceSpan = document.getElementById('balance');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const logoutBtn = document.getElementById('logoutBtn');
            const loggedInUserSpan = document.getElementById('loggedInUser');

            const filterTypeSelect = document.getElementById('filterType');
            const filterCategoryInput = document.getElementById('filterCategory');
            const filterDescriptionInput = document.getElementById('filterDescription');
            const filterStartDateInput = document.getElementById('filterStartDate');
            const filterEndDateInput = document.getElementById('filterEndDate');
            const applyFilterBtn = document.getElementById('applyFilterBtn');
            const clearFilterBtn = document.getElementById('clearFilterBtn');

            const generalSummaryIncomeSpan = document.getElementById('generalSummaryIncome');
            const generalSummaryExpenseSpan = document.getElementById('generalSummaryExpense');
            const generalSummaryNetBalanceSpan = document.getElementById('generalSummaryNetBalance');

            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const applyMonthlySummaryFilterBtn = document.getElementById('applyMonthlySummaryFilterBtn');
            const monthlyNetBalanceSpan = document.getElementById('monthlyNetBalanceValue');
            const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
            let monthlyChartInstance = null;

            const annualYearSelect = document.getElementById('annualYearSelect');
            const applyAnnualSummaryFilterBtn = document.getElementById('applyAnnualSummaryFilterBtn');
            const annualNetBalanceSpan = document.getElementById('annualNetBalanceValue');
            const annualSummaryChartCanvas = document.getElementById('annualSummaryChart');
            let annualChartInstance = null;

            const addCategoryInput = document.getElementById('addCategoryInput');
            const addCategoryTypeSelect = document.getElementById('addCategoryTypeSelect');
            const submitCategoryBtn = document.getElementById('submitCategoryBtn');
            const cancelCategoryEditBtn = document.getElementById('cancelCategoryEditBtn');
            const categoryFormTitle = document.getElementById('categoryFormTitle');
            const categoriesListInForm = document.getElementById('categoriesListInForm');

            let editingCategoryId = null;
            let editingTransactionId = null;

            // Sidebar ve Yeni Butonlar
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');
            const mainContent = document.getElementById('mainContent');

            const manageProductsBtn = document.getElementById('manageProductsBtn');
            const goToSalesManagementBtn = document.getElementById('goToSalesManagementBtn');
            const manageRecurringTransactionsBtn = document.getElementById('manageRecurringTransactionsBtn');
            const viewReportsBtn = document.getElementById('viewReportsBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const importCsvBtn = document.getElementById('importCsvBtn');
            const importCsvModal = document.getElementById('importCsvModal');
            const closeImportCsvModalBtn = document.getElementById('closeImportCsvModalBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const uploadCsvBtn = document.getElementById('uploadCsvBtn');
            const importResultDiv = document.getElementById('importResult');
            const importSummaryP = document.getElementById('importSummary');
            const importFailedListUl = document.getElementById('importFailedList');


            const recurringTransactionsModal = document.getElementById('recurringTransactionsModal');
            const closeRecurringTransactionsModalBtn = document.getElementById('closeRecurringTransactionsModalBtn');
            const processDueRecurringTransactionsBtn = document.getElementById('processDueRecurringTransactionsBtn');

            const recurringTransactionNameInput = document.getElementById('recurringTransactionName');
            const recurringTransactionAmountInput = document.getElementById('recurringTransactionAmount');
            const recurringTransactionTypeSelect = document.getElementById('recurringTransactionType');
            const recurringTransactionCategorySelect = document.getElementById('recurringTransactionCategorySelect');
            const recurringTransactionDescriptionInput = document.getElementById('recurringTransactionDescription');
            const recurringTransactionStartDateInput = document.getElementById('recurringTransactionStartDate');
            const recurringTransactionFrequencySelect = document.getElementById('recurringTransactionFrequency');
            const recurringTransactionIsActiveCheckbox = document.getElementById('recurringTransactionIsActive');
            const submitRecurringTransactionBtn = document.getElementById('submitRecurringTransactionBtn');
            const cancelRecurringTransactionEditBtn = document.getElementById('cancelRecurringTransactionEditBtn');
            const recurringTransactionFormTitle = document.getElementById('recurringTransactionFormTitle');
            const recurringTransactionsListInModal = document.getElementById('recurringTransactionsListInModal');

            let editingRecurringTransactionId = null;

            const manageProfileBtn = document.getElementById('manageProfileBtn');
            const profileModal = document.getElementById('profileModal');
            const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');

            // 2FA ile ilgili yeni elemanlar
            const twoFASetupArea = document.getElementById('twoFASetupArea');
            const twoFAStatusSpan = document.getElementById('twoFAStatus');
            const toggle2FABtn = document.getElementById('toggle2FABtn');
            const recoveryCodesArea = document.getElementById('recoveryCodesArea');
            const recoveryCodesList = document.getElementById('recoveryCodesList');
            const generateNewRecoveryCodesBtn = document.getElementById('generateNewRecoveryCodesBtn');

            // 2FA Modalı Elementleri
            const twoFactorAuthModal = document.getElementById('twoFactorAuthModal');
            const twoFactorAuthCodeInput = document.getElementById('twoFactorAuthCodeInput');
            const verifyTwoFactorAuthBtn = document.getElementById('verifyTwoFactorAuthBtn');
            const resendTwoFactorAuthCodeBtn = document.getElementById('resendTwoFactorAuthCodeBtn');
            const useRecoveryCodeBtn = document.getElementById('useRecoveryCodeBtn');
            const twoFactorAuthModalTitle = document.getElementById('twoFactorAuthModalTitle');
            const twoFactorAuthMessage = document.getElementById('twoFactorAuthMessage');
            const closeTwoFactorAuthModalBtn2FA = document.getElementById('closeTwoFactorAuthModalBtn');

            console.log("All DOM elements defined.");


            // TwoFactorAuthHandler'ı başlat
            if (TwoFactorAuthHandler && twoFactorAuthModal && twoFactorAuthCodeInput && verifyTwoFactorAuthBtn && resendTwoFactorAuthCodeBtn && useRecoveryCodeBtn && twoFactorAuthModalTitle && twoFactorAuthMessage) {
                TwoFactorAuthHandler.init({
                    twoFactorAuthModal: twoFactorAuthModal,
                    twoFactorAuthCodeInput: twoFactorAuthCodeInput,
                    verifyTwoFactorAuthBtn: verifyTwoFactorAuthBtn,
                    resendTwoFactorAuthCodeBtn: resendTwoFactorAuthCodeBtn,
                    useRecoveryCodeBtn: useRecoveryCodeBtn,
                    twoFactorAuthModalTitle: twoFactorAuthModalTitle,
                    twoFactorAuthMessage: twoFactorAuthMessage,
                    API_BASE_URL: API_BASE_URL,
                    showMessage: showMessage
                });
            } else {
                console.error("TwoFactorAuthHandler veya gerekli 2FA modal elementleri bulunamadı. 2FA modülü başlatılamadı.");
            }


            // 2FA Modalı Olay Dinleyicileri
            if (closeTwoFactorAuthModalBtn2FA) {
                closeTwoFactorAuthModalBtn2FA.addEventListener('click', () => {
                    TwoFactorAuthHandler.hide2FAModal();
                    fetchUser2FAStatus();
                });
            } else { console.error("Close 2FA Modal button not found!"); }


            // Sidebar'ı kapatma fonksiyonu
            const closeSidebar = () => {
                console.log("Closing sidebar...");
                if (sidebar) sidebar.classList.add('-translate-x-full');
                if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
                if (mainContent) mainContent.classList.remove('lg:ml-64');
            };

            // Sidebar'ı açma fonksiyonu
            const openSidebar = () => {
                console.log("Opening sidebar...");
                if (sidebar) sidebar.classList.remove('-translate-x-full');
                if (sidebarOverlay) sidebarOverlay.classList.remove('hidden');
                if (window.innerWidth >= 1024 && mainContent) {
                    mainContent.classList.add('lg:ml-64');
                }
            };

            // Sayfa yüklendiğinde ve pencere boyutu değiştiğinde düzeni ayarla
            const initializeSidebarState = () => {
                console.log("Initializing sidebar state...");
                closeSidebar();
                if (window.innerWidth >= 1024) {
                    openSidebar();
                }
            };

            // Pencere boyutu değiştiğinde düzeni yeniden ayarla
            window.addEventListener('resize', initializeSidebarState);

            // Sidebar açma/kapama butonu
            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', () => {
                    if (sidebar && sidebar.classList.contains('-translate-x-full')) {
                        openSidebar();
                    } else {
                        closeSidebar();
                    }
                });
            } else { console.error("Sidebar toggle button not found!"); }

            // Sidebar içindeki kapatma butonu
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    closeSidebar();
                });
            } else { console.error("Close sidebar button not found!"); }

            // Sidebar overlay'ine tıklayınca kapat
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    closeSidebar();
                });
            } else { console.error("Sidebar overlay not found!"); }


            if (importCsvBtn) {
                importCsvBtn.addEventListener('click', () => {
                    if (importCsvModal) importCsvModal.classList.remove('hidden');
                    if (csvFileInput) csvFileInput.value = '';
                    if (importResultDiv) importResultDiv.classList.add('hidden');
                    if (importSummaryP) importSummaryP.textContent = '';
                    if (importFailedListUl) importFailedListUl.innerHTML = '';
                    closeSidebar();
                });
            } else { console.error("Import CSV button not found!"); }

            if (closeImportCsvModalBtn) {
                closeImportCsvModalBtn.addEventListener('click', () => {
                    if (importCsvModal) importCsvModal.classList.add('hidden');
                });
            } else { console.error("Close Import CSV Modal button not found!"); }

            window.addEventListener('click', (event) => {
                if (event.target === importCsvModal) {
                    if (importCsvModal) importCsvModal.classList.add('hidden');
                }
            });

            if (uploadCsvBtn) {
                uploadCsvBtn.addEventListener('click', async () => {
                    const files = csvFileInput ? csvFileInput.files : [];
                    if (files.length === 0) {
                        showMessage('Lütfen içe aktarmak için bir CSV dosyası seçin.', 'error');
                        return;
                    }

                    const file = files[0];
                    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                        showMessage('Lütfen sadece CSV uzantılı bir dosya seçin.', 'error');
                        return;
                    }

                    if (uploadCsvBtn) {
                        uploadCsvBtn.disabled = true;
                        uploadCsvBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> İçe Aktarılıyor...';
                    }


                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const csvContent = e.target.result;
                        showMessage('CSV dosyası içe aktarılıyor...', 'info');

                        try {
                            const response = await fetch(`${API_BASE_URL}/transactions/import-csv?timestamp=${Date.now()}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ csvData: csvContent })
                            });

                            const result = await response.json();

                            if (!response.ok) {
                                if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                throw new Error(result.message || 'CSV içe aktarma başarısız oldu.');
                            }

                            if (importResultDiv) importResultDiv.classList.remove('hidden');
                            if (importSummaryP) importSummaryP.textContent = `${result.importedCount} işlem başarıyla içe aktarıldı, ${result.failedCount} işlem başarısız oldu.`;

                            if (importFailedListUl) importFailedListUl.innerHTML = '';
                            if (result.failedRecords && result.failedRecords.length > 0) {
                                result.failedRecords.forEach(record => {
                                    const listItem = document.createElement('li');
                                    listItem.textContent = `Satır ${record.line}: ${record.reason} - Veri: "${record.data}"`;
                                    if (importFailedListUl) importFailedListUl.appendChild(listItem);
                                });
                            } else {
                                if (importFailedListUl) importFailedListUl.innerHTML = '<li>Başarısız kayıt bulunmamaktadır.</li>';
                            }

                            showMessage(result.message, result.failedCount > 0 ? 'warning' : 'success');

                            const currentYear = new Date().getFullYear();
                            const currentMonth = new Date().getMonth();
                            await Promise.all([
                                fetchTransactions(),
                                fetchGeneralFinancialSummary(),
                                fetchMonthlySummary(currentYear, currentMonth),
                                fetchAnnualSummary(currentYear),
                                fetchCategories()
                            ]);

                        } catch (error) {
                            console.error('CSV içe aktarılırken hata:', error);
                            showMessage(`CSV içe aktarılırken bir hata oluştu: ${error.message}`, 'error');
                            if (importResultDiv) importResultDiv.classList.remove('hidden');
                            if (importSummaryP) importSummaryP.textContent = `İçe aktarma sırasında kritik bir hata oluştu.`;
                            if (importFailedListUl) importFailedListUl.innerHTML = `<li class="text-red-600">${error.message}</li>`;
                        } finally {
                            if (uploadCsvBtn) {
                                uploadCsvBtn.disabled = false;
                                uploadCsvBtn.innerHTML = 'İçe Aktar';
                            }
                        }
                    };
                    reader.readAsText(file);
                });
            } else { console.error("Upload CSV button not found!"); }


            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', async () => {
                    if (exportCsvBtn) {
                        exportCsvBtn.disabled = true;
                        exportCsvBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> Dışa Aktarılıyor...';
                    }
                    closeSidebar();

                    try {
                        showMessage('İşlemleriniz CSV olarak dışa aktarılıyor...', 'info');
                        const response = await fetch(`${API_BASE_URL}/transactions/export-csv?timestamp=${Date.now()}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`
                            }
                        });

                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                            throw new Error(`HTTP hata! Durum: ${response.status}`);
                        }

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'fingo_islemler.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showMessage('İşlemler başarıyla CSV olarak dışa aktarıldı!', 'success');

                    } catch (error) {
                        console.error('CSV dışa aktarırken hata:', error);
                        showMessage(`CSV dışa aktarılırken bir hata oluştu: ${error.message}`, 'error');
                    } finally {
                        if (exportCsvBtn) {
                            exportCsvBtn.disabled = false;
                            exportCsvBtn.innerHTML = 'Verileri Dışa Aktar (CSV)';
                        }
                    }
                });
            } else { console.error("Export CSV button not found!"); }


            if (manageProfileBtn) {
                manageProfileBtn.addEventListener('click', async () => {
                    if (profileModal) profileModal.classList.remove('hidden');
                    if (currentPasswordInput) currentPasswordInput.value = '';
                    if (newPasswordInput) newPasswordInput.value = '';
                    await fetchUser2FAStatus();
                    closeSidebar();
                });
            } else { console.error("Manage Profile button not found!"); }

            if (closeProfileModalBtn) {
                closeProfileModalBtn.addEventListener('click', () => {
                    if (profileModal) profileModal.classList.add('hidden');
                });
            } else { console.error("Close Profile Modal button not found!"); }

            window.addEventListener('click', (event) => {
                if (event.target === profileModal) {
                    if (profileModal) profileModal.classList.add('hidden');
                }
            });

            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', async () => {
                    const currentPassword = currentPasswordInput ? currentPasswordInput.value : '';
                    const newPassword = newPasswordInput ? newPasswordInput.value : '';

                    if (!currentPassword || !newPassword) {
                        showMessage('Lütfen mevcut ve yeni parolanızı girin.', 'error');
                        return;
                    }
                    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!^#@?_=)(]).*$/;
                    if (newPassword.length < 8 || newPassword.length > 50 || !passwordRegex.test(newPassword)) {
                        showMessage('Yeni parola en az 8 karakter, büyük/küçük harf, rakam ve özel karakter (! ^ # @ ? _ = ) ( ) ) içermelidir.', 'error');
                        return;
                    }
                    if (currentPassword === newPassword) {
                        showMessage('Yeni parola mevcut parolanızla aynı olamaz.', 'error');
                        return;
                    }

                    if (updatePasswordBtn) {
                        updatePasswordBtn.disabled = true;
                        updatePasswordBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> Güncelleniyor...';
                    }


                    try {
                        const response = await fetch(`${API_BASE_URL}/users/change-password`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${jwtToken}`
                            },
                            body: JSON.stringify({ currentPassword, newPassword })
                        });
                        const result = await response.json();

                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                            throw new Error(result.message || 'Parola güncelleme başarısız oldu.');
                        }
                        showMessage(result.message, 'success');
                        if (profileModal) profileModal.classList.add('hidden');
                    } catch (error) {
                        console.error('Parola güncellerken hata:', error);
                        showMessage(`Parola güncellenirken bir hata oluştu: ${error.message}`, 'error');
                    } finally {
                        if (updatePasswordBtn) {
                            updatePasswordBtn.disabled = false;
                            updatePasswordBtn.innerHTML = 'Parolayı Güncelle';
                        }
                    }
                });
            } else { console.error("Update Password button not found!"); }

            // 2FA Durumunu Çekme ve UI'ı Güncelleme (GÜNCELLENDİ)
            async function fetchUser2FAStatus() {
                if (twoFAStatusSpan) twoFAStatusSpan.textContent = 'Durum: Yükleniyor...';
                if (toggle2FABtn) toggle2FABtn.classList.add('hidden');
                if (recoveryCodesArea) recoveryCodesArea.classList.add('hidden');
                if (generateNewRecoveryCodesBtn) generateNewRecoveryCodesBtn.classList.add('hidden');
                if (toggle2FABtn) toggle2FABtn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/users/me?timestamp=${Date.now()}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`Kullanıcı bilgileri çekilemedi: ${response.statusText}`);
                    }
                    const data = await response.json();

                    if (data.is2FAEnabled) {
                        if (twoFAStatusSpan) {
                            twoFAStatusSpan.textContent = 'Durum: ETKİN';
                            twoFAStatusSpan.classList.remove('text-red-600');
                            twoFAStatusSpan.classList.add('text-green-600');
                        }
                        if (toggle2FABtn) {
                            toggle2FABtn.textContent = '2FA\'yı Devre Dışı Bırak';
                            toggle2FABtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                            toggle2FABtn.classList.add('bg-red-500', 'hover:bg-red-600');
                        }
                        if (recoveryCodesArea) recoveryCodesArea.classList.remove('hidden');
                        if (generateNewRecoveryCodesBtn) generateNewRecoveryCodesBtn.classList.remove('hidden');
                        if (recoveryCodesList) recoveryCodesList.innerHTML = '<li class="col-span-2 text-center text-gray-500">Kurtarma kodları sadece 2FA etkinleştirildiğinde bir kez gösterilir. Yenilerini oluşturabilirsiniz.</li>';

                    } else {
                        if (twoFAStatusSpan) {
                            twoFAStatusSpan.textContent = 'Durum: DEVRE DIŞI';
                            twoFAStatusSpan.classList.remove('text-green-600');
                            twoFAStatusSpan.classList.add('text-red-600');
                        }
                        if (toggle2FABtn) {
                            toggle2FABtn.textContent = '2FA\'yı Etkinleştir';
                            toggle2FABtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                            toggle2FABtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        }
                        if (recoveryCodesArea) recoveryCodesArea.classList.add('hidden');
                        if (generateNewRecoveryCodesBtn) generateNewRecoveryCodesBtn.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('2FA durumu çekilirken hata:', error);
                    if (twoFAStatusSpan) {
                        twoFAStatusSpan.textContent = `Durum: HATA (${error.message})`;
                        twoFAStatusSpan.classList.remove('text-green-600');
                        twoFAStatusSpan.classList.add('text-red-600');
                    }
                } finally {
                    if (toggle2FABtn) toggle2FABtn.classList.remove('hidden');
                    if (toggle2FABtn) toggle2FABtn.disabled = false;
                }
            }

            // Kurtarma kodlarını UI'da gösterme
            function displayRecoveryCodes(codes) {
                if (recoveryCodesList) recoveryCodesList.innerHTML = '';
                if (codes.length === 0) {
                    if (recoveryCodesList) recoveryCodesList.innerHTML = '<li class="col-span-2 text-center text-gray-500">Kurtarma kodu bulunamadı. Yeni kodlar oluşturun.</li>';
                } else {
                    codes.forEach(code => {
                        const li = document.createElement('li');
                        li.textContent = code;
                        li.className = 'bg-white p-2 rounded-md border border-gray-100 flex items-center justify-between';
                        if (recoveryCodesList) recoveryCodesList.appendChild(li);
                    });
                }
            }

            // 2FA'yı etkinleştir/devre dışı bırak butonu
            if (toggle2FABtn) {
                toggle2FABtn.addEventListener('click', async () => {
                    if (toggle2FABtn) {
                        toggle2FABtn.disabled = true;
                        toggle2FABtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> İşleniyor...';
                    }

                    const isCurrentlyEnabled = twoFAStatusSpan && twoFAStatusSpan.textContent.includes('ETKİN');

                    try {
                        if (isCurrentlyEnabled) {
                            showMessage(`2FA'yı devre dışı bırakmak istediğinizden emin misiniz? <div class="flex justify-center mt-4 space-x-4"><button id="confirmToggleBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Evet</button> <button id="cancelToggleBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">İptal</button></div>`, 'confirm');

                            await new Promise((resolve) => {
                                const confirmBtn = document.getElementById('confirmToggleBtn');
                                const cancelBtn = document.getElementById('cancelToggleBtn');
                                if (confirmBtn) confirmBtn.onclick = async () => { resolve(true); };
                                if (cancelBtn) cancelBtn.onclick = () => { resolve(false); };
                            }).then(async confirmed => {
                                if (messageBox) messageBox.classList.add('hidden');
                                if (confirmed) {
                                    await execute2FAToggle(false);
                                } else {
                                    if (toggle2FABtn) {
                                        toggle2FABtn.disabled = false;
                                        toggle2FABtn.innerHTML = '2FA\'yı Devre Dışı Bırak';
                                    }
                                }
                            });


                        } else {
                            showMessage('2FA etkinleştirme kodu e-postanıza gönderiliyor...', 'info');
                            const response = await fetch(`${API_BASE_URL}/2fa/setup`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ enable: true })
                            });
                            const result = await response.json();

                            if (!response.ok) {
                                if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                throw new Error(result.message || '2FA etkinleştirme başlatılamadı.');
                            }
                            showMessage(result.message, 'success');

                            TwoFactorAuthHandler.show2FAModal('setup', decodedToken.email, jwtToken);
                            if (result.recoveryCodes && result.recoveryCodes.length > 0) {
                                displayRecoveryCodes(result.recoveryCodes);
                            }
                        }
                    } catch (error) {
                        console.error('2FA geçiş hatası:', error);
                        showMessage(`2FA işlemi sırasında bir hata oluştu: ${error.message}`, 'error');
                    } finally {
                        if (toggle2FABtn) {
                            toggle2FABtn.disabled = false;
                            toggle2FABtn.innerHTML = isCurrentlyEnabled ? '2FA\'yı Devre Dışı Bırak' : '2FA\'yı Etkinleştir';
                        }
                    }
                });
            } else { console.error("Toggle 2FA button not found!"); }


            // 2FA Etkinleştirme/Devre Dışı Bırakma işlemini gerçekleştiren yardımcı fonksiyon (GÜNCELLENDİ)
            async function execute2FAToggle(enable) {
                try {
                    const response = await fetch(`${API_BASE_URL}/2fa/setup`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${jwtToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enable: enable })
                    });
                    const result = await response.json();

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(result.message || 'İşlem başarısız oldu.');
                    }
                    showMessage(result.message, 'success');
                    await fetchUser2FAStatus();
                    if (enable && result.recoveryCodes && result.recoveryCodes.length > 0) {
                        displayRecoveryCodes(result.recoveryCodes);
                    }

                } catch (error) {
                    console.error('2FA geçiş hatası:', error);
                    showMessage(`2FA işlemi sırasında bir hata oluştu: ${error.message}`, 'error');
                }
            }


            // Yeni Kurtarma Kodları Oluşturma
            if (generateNewRecoveryCodesBtn) {
                generateNewRecoveryCodesBtn.addEventListener('click', async () => {
                    if (generateNewRecoveryCodesBtn) {
                        generateNewRecoveryCodesBtn.disabled = true;
                        generateNewRecoveryCodesBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> Oluşturuluyor...';
                    }

                    showMessage(`Yeni kurtarma kodları oluşturmak istediğinizden emin misiniz? Eski kodlar geçersiz olacaktır. <div class="flex justify-center mt-4 space-x-4"><button id="confirmGenerateBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Evet</button> <button id="cancelGenerateBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">İptal</button></div>`, 'confirm');

                    const confirmBtn = document.getElementById('confirmGenerateBtn');
                    const cancelBtn = document.getElementById('cancelGenerateBtn');

                    if (confirmBtn) confirmBtn.onclick = async () => {
                        try {
                            const response = await fetch(`${API_BASE_URL}/2fa/generate-new-recovery-codes`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${jwtToken}` }
                            });
                            const result = await response.json();

                            if (!response.ok) {
                                if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                throw new Error(result.message || 'Kurtarma kodları oluşturulamadı.');
                            }
                            showMessage(result.message, 'success');
                            displayRecoveryCodes(result.recoveryCodes);
                        } catch (error) {
                            console.error('Yeni kurtarma kodları oluşturma hatası:', error);
                            showMessage(`Yeni kurtarma kodları oluşturulurken bir hata oluştu: ${error.message}`, 'error');
                        } finally {
                            if (messageBox) messageBox.classList.add('hidden');
                            if (generateNewRecoveryCodesBtn) {
                                generateNewRecoveryCodesBtn.disabled = false;
                                generateNewRecoveryCodesBtn.innerHTML = 'Yeni Kurtarma Kodları Oluştur';
                            }
                        }
                    };

                    if (cancelBtn) cancelBtn.onclick = () => {
                        if (messageBox) messageBox.classList.add('hidden');
                        if (generateNewRecoveryCodesBtn) {
                            generateNewRecoveryCodesBtn.disabled = false;
                            generateNewRecoveryCodesBtn.innerHTML = 'Yeni Kurtarma Kodları Oluştur';
                        }
                    };
                });
            } else { console.error("Generate New Recovery Codes button not found!"); }


            const monthNames = [
                "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
                "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
            ];

            if (loggedInUserSpan && decodedToken && decodedToken.email) {
                loggedInUserSpan.textContent = `Hoş Geldin, ${decodedToken.email.split('@')[0]}...`;
            } else { console.error("Logged in user span or decoded token not found!"); }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('fingoNotifications');
                    window.location.href = 'auth.html';
                });
            } else { console.error("Logout button not found!"); }


            // showMessage fonksiyonu - Modalın CSS'i head içinde tanımlanmalı
            function showMessage(message, type = 'success') {
                if (!messageBox || !messageText) {
                    console.error("Message box elements (messageBox or messageText) not found! Cannot display message.");
                    return;
                }
                messageText.innerHTML = message;
                messageBox.className = `message-box show ${type}`;
                messageBox.classList.remove('hidden');
                if (type !== 'confirm') {
                    setTimeout(() => {
                        messageBox.classList.remove('show');
                        setTimeout(() => {
                            messageBox.classList.add('hidden');
                        }, 300);
                    }, 3000);
                } else {
                    // Confirm mesajı için butonlar zaten HTML içinde, burada bir şey yapmaya gerek yok
                }
            }

            function handleAuthError() {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('fingoNotifications');
                showMessage('Oturumunuz sona erdi. Lütfen tekrar giriş yapın.', 'error');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 1500);
            }

            // Finansal Özetleri Çekme Fonksiyonları
            async function fetchGeneralFinancialSummary() {
                try {
                    const response = await fetch(`${API_BASE_URL}/financial-summary/general?timestamp=${Date.now()}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const summary = await response.json();

                    if (generalSummaryIncomeSpan) generalSummaryIncomeSpan.textContent = `${parseFloat(summary.totalRevenue).toFixed(2)} TL`;
                    if (generalSummaryExpenseSpan) generalSummaryExpenseSpan.textContent = `${parseFloat(summary.totalExpenses).toFixed(2)} TL`;
                    if (generalSummaryNetBalanceSpan) generalSummaryNetBalanceSpan.textContent = `${parseFloat(summary.currentBalance).toFixed(2)} TL`;
                    if (balanceSpan) balanceSpan.textContent = `${parseFloat(summary.currentBalance).toFixed(2)} TL`;
                } catch (error) {
                    console.error('Genel finansal özet çekerken hata:', error);
                    if (generalSummaryIncomeSpan) generalSummaryIncomeSpan.textContent = `Hata!`;
                    if (generalSummaryExpenseSpan) generalSummaryExpenseSpan.textContent = `Hata!`;
                    if (generalSummaryNetBalanceSpan) generalSummaryNetBalanceSpan.textContent = `Hata!`;
                    if (balanceSpan) balanceSpan.textContent = 'Hata!';
                }
            }

            async function fetchMonthlySummary(year, month) {
                try {
                    const url = `${API_BASE_URL}/financial-summary/monthly?year=${year}&month=${month}&timestamp=${Date.now()}`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const summaryDataArray = await response.json();
                    const summaryData = summaryDataArray.find(s => s.year === parseInt(year) && s.month === parseInt(month) + 1) || { income: 0, expense: 0, netBalance: 0 };

                    if (monthlyNetBalanceSpan) monthlyNetBalanceSpan.textContent = `${parseFloat(summaryData.netBalance).toFixed(2)}`;

                    if (monthlyChartInstance) {
                        monthlyChartInstance.destroy();
                    }

                    if (monthlySummaryChartCanvas) {
                        const monthlySummaryChartCtx = monthlySummaryChartCanvas.getContext('2d');
                        monthlyChartInstance = new Chart(monthlySummaryChartCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Gelir', 'Gider'],
                                datasets: [{
                                    label: 'Miktar (₺)',
                                    data: [parseFloat(summaryData.income), parseFloat(summaryData.expense)],
                                    backgroundColor: [
                                        'rgba(52, 211, 153, 0.6)',
                                        'rgba(248, 113, 113, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(52, 211, 153, 1)',
                                        'rgba(248, 113, 113, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: `${monthNames[month]} ${year} Özeti`
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Miktar (₺)'
                                        }
                                    }
                                }
                            }
                        });
                    } else { console.error("Monthly Summary Chart canvas not found!"); }

                } catch (error) {
                    console.error('Aylık finansal özet çekerken hata:', error);
                    if (monthlyNetBalanceSpan) monthlyNetBalanceSpan.textContent = `Hata!`;
                    if (monthlyChartInstance) {
                        monthlyChartInstance.destroy();
                        monthlyChartInstance = null;
                    }
                }
            }

            async function fetchAnnualSummary(year) {
                try {
                    const url = `${API_BASE_URL}/financial-summary/annual?year=${year}&timestamp=${Date.now()}`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const summaryDataArray = await response.json();
                    const summaryData = summaryDataArray.find(s => s.year === parseInt(year)) || { income: 0, expense: 0, netBalance: 0 };

                    if (annualNetBalanceSpan) annualNetBalanceSpan.textContent = `${parseFloat(summaryData.netBalance).toFixed(2)}`;

                    if (annualChartInstance) {
                        annualChartInstance.destroy();
                    }

                    if (annualSummaryChartCanvas) {
                        const annualSummaryChartCtx = annualSummaryChartCanvas.getContext('2d');
                        annualChartInstance = new Chart(annualSummaryChartCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Gelir', 'Gider'],
                                datasets: [{
                                    label: 'Miktar (₺)',
                                    data: [parseFloat(summaryData.income), parseFloat(summaryData.expense)],
                                    backgroundColor: [
                                        'rgba(52, 211, 153, 0.6)',
                                        'rgba(248, 113, 113, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(52, 211, 153, 1)',
                                        'rgba(248, 113, 113, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: `${year} Yılı Özeti`
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Miktar (₺)'
                                        }
                                    }
                                }
                            }
                        });
                    } else { console.error("Annual Summary Chart canvas not found!"); }

                } catch (error) {
                    console.error('Yıllık finansal özet çekerken hata:', error);
                    if (annualNetBalanceSpan) annualNetBalanceSpan.textContent = `Hata!`;
                    if (annualChartInstance) {
                        annualChartInstance.destroy();
                        annualChartInstance = null;
                    }
                }
            }

            // İşlemleri Çekme ve Listeleme Fonksiyonları
            async function fetchTransactions() {
                if (transactionsLoadingOverlay) transactionsLoadingOverlay.classList.remove('hidden');
                if (balanceSpan) balanceSpan.textContent = '0.00 TL';
                if (transactionsListDiv) transactionsListDiv.innerHTML = '';

                try {
                    const queryParams = new URLSearchParams();
                    if (filterTypeSelect && filterTypeSelect.value) { queryParams.append('type', filterTypeSelect.value); }
                    if (filterCategoryInput && filterCategoryInput.value.trim()) { queryParams.append('category', filterCategoryInput.value.trim()); }
                    if (filterDescriptionInput && filterDescriptionInput.value.trim()) { queryParams.append('description', filterDescriptionInput.value.trim()); }
                    if (filterStartDateInput && filterStartDateInput.value) { queryParams.append('startDate', filterStartDateInput.value); }
                    if (filterEndDateInput && filterEndDateInput.value) { queryParams.append('endDate', filterEndDateInput.value); }

                    const url = `${API_BASE_URL}/transactions?${queryParams.toString()}&timestamp=${Date.now()}`;

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${jwtToken}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const transactions = await response.json();
                    console.log("fetchTransactions tarafından alınan veriler:", transactions);

                    let totalBalance = 0;

                    if (transactions.length === 0) {
                        if (transactionsListDiv) transactionsListDiv.innerHTML = '<p class="text-center text-gray-500 py-4">Henüz işlem bulunmamaktadır.</p>';
                    } else {
                        transactions.forEach(tx => {
                            const transactionItem = document.createElement('div');
                            const typeColor = tx.type === 'Gelir' ? 'text-green-600' : 'text-red-600';
                            const amountSign = tx.type === 'Gelir' ? '+' : '-';

                            const dateObj = new Date(tx.date);
                            const formattedDate = dateObj.toLocaleDateString('tr-TR', { year: 'numeric', month: '2-digit', day: '2-digit' });


                            transactionItem.className = `p-3 bg-white rounded-md shadow-sm border border-gray-100 flex justify-between items-center`;
                            transactionItem.dataset.id = tx._id;
                            transactionItem.innerHTML = `
                                    <div>
                                        <p class="text-gray-800 font-medium">${tx.description || 'Açıklama Yok'}</p>
                                        <p class="text-sm text-gray-500">${tx.category || 'Kategori Yok'} - ${formattedDate}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <p class="font-bold ${typeColor}">${amountSign}${tx.amount.toFixed(2)} TL</p>
                                        <button class="edit-btn p-1 rounded-full hover:bg-yellow-200 text-yellow-600 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                                            </svg>
                                        </button>
                                        <button class="delete-btn p-1 rounded-full hover:bg-red-200 text-red-600 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm6 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                `;
                            if (transactionsListDiv) transactionsListDiv.appendChild(transactionItem);

                            if (tx.type === 'Gelir') {
                                totalBalance += tx.amount;
                            } else {
                                totalBalance -= tx.amount;
                            }
                        });
                    }
                    if (balanceSpan) balanceSpan.textContent = `${totalBalance.toFixed(2)} TL`;
                    addEventListenersToTransactionButtons();

                } catch (error) {
                    console.error('İşlemleri çekerken hata:', error);
                    if (transactionsListDiv) transactionsListDiv.innerHTML = `<p class="text-center text-red-500 py-4">İşlemler yüklenirken bir hata oluştu: ${error.message}</p>`;
                    if (balanceSpan) balanceSpan.textContent = 'Hata!';
                } finally {
                    if (transactionsLoadingOverlay) transactionsLoadingOverlay.classList.add('hidden');
                }
            }

            // İşlem Ekle/Güncelle Butonu Olay Dinleyicisi
            if (submitTransactionBtn) {
                submitTransactionBtn.addEventListener('click', async () => {
                    console.log("Submit transaction button clicked.");
                    const type = transactionTypeSelect ? transactionTypeSelect.value : '';
                    const amount = amountInput ? parseFloat(amountInput.value) : 0;
                    const description = descriptionInput ? descriptionInput.value.trim() : '';
                    const category = categorySelect ? categorySelect.value : '';
                    const date = transactionDateInput ? transactionDateInput.value : '';

                    if (!type || isNaN(amount) || amount <= 0 || !description || !date) {
                        showMessage('Lütfen tüm gerekli işlem alanlarını doldurun (Miktar pozitif bir sayı olmalı).', 'error');
                        return;
                    }

                    if (submitTransactionBtn) {
                        submitTransactionBtn.disabled = true;
                        submitTransactionBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> Kaydediliyor...';
                    }

                    try {
                        let response;
                        if (editingTransactionId) {
                            response = await fetch(`${API_BASE_URL}/transactions/${editingTransactionId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ type, amount, description, category, date })
                            });
                        } else {
                            response = await fetch(`${API_BASE_URL}/transactions`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ type, amount, description, category, date })
                            });
                        }

                        const result = await response.json();

                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                            throw new Error(result.message || 'İşlem kaydetme başarısız oldu.');
                        }
                        showMessage(result.message, 'success');
                        resetForm();
                        const currentYear = new Date().getFullYear();
                        const currentMonth = new Date().getMonth();
                        await Promise.all([
                            fetchTransactions(),
                            fetchGeneralFinancialSummary(),
                            fetchMonthlySummary(currentYear, currentMonth),
                            fetchAnnualSummary(currentYear)
                        ]);
                    } catch (error) {
                        console.error('İşlem kaydederken hata:', error);
                        showMessage(`İşlem kaydedilirken bir hata oluştu: ${error.message}`, 'error');
                    } finally {
                        if (submitTransactionBtn) {
                            submitTransactionBtn.disabled = false;
                            submitTransactionBtn.innerHTML = editingTransactionId ? 'İşlem Güncelle' : 'İşlem Ekle';
                        }
                    }
                });
            } else { console.error("Submit transaction button not found!"); }

            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    console.log("Cancel transaction edit button clicked.");
                    resetForm();
                });
            } else { console.error("Cancel edit button not found!"); }


            function resetForm() {
                if (transactionTypeSelect) transactionTypeSelect.value = 'Gider';
                if (amountInput) amountInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (categorySelect) categorySelect.value = '';
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                if (transactionDateInput) transactionDateInput.value = `${year}-${month}-${day}`;

                if (submitTransactionBtn) submitTransactionBtn.textContent = 'İşlem Ekle';
                if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
                if (formTitle) formTitle.textContent = 'Yeni İşlem Ekle';
                editingTransactionId = null;
            }

            // İşlem butonlarına olay dinleyicileri ekleme
            function addEventListenersToTransactionButtons() {
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.onclick = (event) => {
                        console.log("Edit transaction button clicked.");
                        const transactionDiv = event.target.closest('div[data-id]');
                        if (!transactionDiv) { console.error("Transaction div not found for edit button."); return; }
                        const transactionId = transactionDiv.dataset.id;

                        const amountTextElement = transactionDiv.querySelector('.font-bold');
                        const descriptionElement = transactionDiv.querySelector('p:first-child');
                        const categoryAndDateElement = transactionDiv.querySelector('p:last-child');

                        if (!amountTextElement || !descriptionElement || !categoryAndDateElement) {
                            console.error("Missing elements within transaction item for editing.");
                            return;
                        }

                        const amountText = amountTextElement.textContent;
                        const type = amountText.startsWith('+') ? 'Gelir' : 'Gider';
                        const amount = parseFloat(amountText.replace(/[+-]|\sTL/g, ''));
                        const description = descriptionElement.textContent;
                        const categoryAndDateText = categoryAndDateElement.textContent;
                        const [category, datePart] = categoryAndDateText.split(' - ');
                        const parts = datePart.split('.');
                        const formattedDateForInput = `${parts[2]}-${parts[1]}-${parts[0]}`;


                        if (transactionTypeSelect) transactionTypeSelect.value = type;
                        if (amountInput) amountInput.value = amount;
                        if (descriptionInput) descriptionInput.value = description.replace('Açıklama Yok', '');
                        if (categorySelect) {
                            categorySelect.value = category.replace('Kategori Yok', '');
                            if (!categorySelect.value) { // Kategori bulunamazsa boş bırak
                                categorySelect.value = "";
                            }
                        }
                        if (transactionDateInput) transactionDateInput.value = formattedDateForInput;

                        if (submitTransactionBtn) submitTransactionBtn.textContent = 'İşlem Güncelle';
                        if (cancelEditBtn) cancelEditBtn.classList.remove('hidden');
                        if (formTitle) formTitle.textContent = 'İşlem Düzenle';
                        editingTransactionId = transactionId;
                    };
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = async (event) => {
                        console.log("Delete transaction button clicked.");
                        const transactionDiv = event.target.closest('div[data-id]');
                        if (!transactionDiv) { console.error("Transaction div not found for delete button."); return; }
                        const transactionId = transactionDiv.dataset.id;

                        showMessage(`Bu işlemi silmek istediğinizden emin misiniz? <div class="flex justify-center mt-4 space-x-4"><button id="confirmDeleteBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Evet, Sil</button> <button id="cancelDeleteBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">İptal</button></div>`, 'confirm');

                        const confirmBtn = document.getElementById('confirmDeleteBtn');
                        const cancelBtn = document.getElementById('cancelDeleteBtn');

                        if (confirmBtn) confirmBtn.onclick = async () => {
                            if (transactionDiv) transactionDiv.remove();
                            showMessage('İşlem siliniyor...', 'info');

                            try {
                                const response = await fetch(`${API_BASE_URL}/transactions/${transactionId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${jwtToken}`
                                    }
                                });

                                const result = await response.json();

                                if (!response.ok) {
                                    if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                    throw new Error(result.message || 'Silme işlemi başarısız oldu.');
                                }
                                showMessage(result.message, 'success');

                                const currentYear = new Date().getFullYear();
                                const currentMonth = new Date().getMonth();
                                await Promise.all([
                                    fetchGeneralFinancialSummary(),
                                    fetchMonthlySummary(currentYear, currentMonth),
                                    fetchAnnualSummary(currentYear)
                                ]);
                                fetchTransactions();
                                resetForm();

                            } catch (error) {
                                console.error('İşlem silerken hata:', error);
                                showMessage(`İşlem silinirken bir hata oluştu: ${error.message}. İşlem geri eklendi.`, 'error');
                                fetchTransactions();

                            } finally {
                                if (messageBox) messageBox.classList.add('hidden');
                            }
                        };

                        if (cancelBtn) cancelBtn.onclick = () => {
                            if (messageBox) messageBox.classList.add('hidden');
                        };
                    };
                });
            }

            // Kategori Fonksiyonları
            async function fetchCategories() {
                try {
                    const response = await fetch(`${API_BASE_URL}/categories?userId=${userId}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const categories = await response.json();

                    // İşlem formu kategori seçimi
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">Kategori Seçin (Opsiyonel)</option>';
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = `${cat.name} (${cat.type})`;
                            categorySelect.appendChild(option);
                        });
                    } else { console.error("Category select not found!"); }

                    // Tekrarlayan işlem formu kategori seçimi
                    if (recurringTransactionCategorySelect) {
                        recurringTransactionCategorySelect.innerHTML = '<option value="">Kategori Seçin (Opsiyonel)</option>';
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = `${cat.name} (${cat.type})`;
                            recurringTransactionCategorySelect.appendChild(option);
                        });
                    } else { console.error("Recurring transaction category select not found!"); }

                    // Kategori yönetim listesi
                    if (categoriesListInForm) {
                        categoriesListInForm.innerHTML = '';
                        if (categories.length === 0) {
                            categoriesListInForm.innerHTML = '<li class="text-center text-gray-500 text-sm">Kategori yok.</li>';
                        } else {
                            categories.forEach(cat => {
                                const listItem = document.createElement('li');
                                listItem.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm border border-gray-100 text-sm';
                                listItem.innerHTML = `
                                        <span>${cat.name} <span class="text-gray-500">(${cat.type})</span></span>
                                        <div>
                                            <button class="edit-category-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${cat._id}" data-name="${cat.name}" data-type="${cat.type}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${cat._id}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    `;
                                if (categoriesListInForm) categoriesListInForm.appendChild(listItem);
                            });
                            addEventListenersToCategoryButtons();
                        }
                    } else { console.error("Categories list in form not found!"); }

                } catch (error) {
                    console.error('Kategorileri çekerken hata:', error);
                    if (categorySelect) categorySelect.innerHTML = '<option value="">Kategoriler yüklenemedi</option>';
                    if (recurringTransactionCategorySelect) recurringTransactionCategorySelect.innerHTML = '<option value="">Kategoriler yüklenemedi</option>';
                    if (categoriesListInForm) categoriesListInForm.innerHTML = '<li class="text-center text-red-500 text-sm">Kategoriler yüklenirken hata oluştu.</li>';
                }
            }

            // Kategori butonlarına olay dinleyicileri ekleme
            if (submitCategoryBtn) {
                submitCategoryBtn.addEventListener('click', async () => {
                    console.log("Submit category button clicked.");
                    const name = addCategoryInput ? addCategoryInput.value.trim() : '';
                    const type = addCategoryTypeSelect ? addCategoryTypeSelect.value : '';

                    if (!name || !type) {
                        showMessage('Lütfen kategori adı ve tipini girin.', 'error');
                        return;
                    }

                    if (submitCategoryBtn) {
                        submitCategoryBtn.disabled = true;
                        submitCategoryBtn.innerHTML = '<span class="inline-block h-4 w-4 border-2 border-t-2 border-white rounded-full animate-spin mr-2"></span> Kaydediliyor...';
                    }

                    try {
                        let response;
                        if (editingCategoryId) {
                            response = await fetch(`${API_BASE_URL}/categories/${editingCategoryId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ name, type })
                            });
                        } else {
                            response = await fetch(`${API_BASE_URL}/categories`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ name, type })
                            });
                        }

                        const result = await response.json();

                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                            throw new Error(result.message || 'Kategori işlemi başarısız oldu.');
                        }
                        showMessage(result.message, 'success');
                        resetCategoryForm();
                        fetchCategories(); // Kategorileri yeniden çek
                    } catch (error) {
                        console.error('Kategori kaydederken hata:', error);
                        showMessage(`Kategori kaydedilirken bir hata oluştu: ${error.message}`, 'error');
                    } finally {
                        if (submitCategoryBtn) {
                            submitCategoryBtn.disabled = false;
                            submitCategoryBtn.innerHTML = editingCategoryId ? 'Güncelle' : 'Kaydet';
                        }
                    }
                });
            } else { console.error("Submit category button not found!"); }

            if (cancelCategoryEditBtn) {
                cancelCategoryEditBtn.addEventListener('click', () => {
                    console.log("Cancel category edit button clicked.");
                    resetCategoryForm();
                });
            } else { console.error("Cancel category edit button not found!"); }

            function addEventListenersToCategoryButtons() {
                document.querySelectorAll('.edit-category-btn').forEach(button => {
                    button.onclick = (event) => {
                        console.log("Edit category button clicked.");
                        const categoryId = event.currentTarget.dataset.id;
                        const categoryName = event.currentTarget.dataset.name;
                        const categoryType = event.currentTarget.dataset.type;

                        if (addCategoryInput) addCategoryInput.value = categoryName;
                        if (addCategoryTypeSelect) addCategoryTypeSelect.value = categoryType;
                        if (submitCategoryBtn) submitCategoryBtn.textContent = 'Güncelle';
                        if (cancelCategoryEditBtn) cancelCategoryEditBtn.classList.remove('hidden');
                        if (categoryFormTitle) categoryFormTitle.textContent = 'Kategori Düzenle';
                        editingCategoryId = categoryId;
                    };
                });

                document.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.onclick = async (event) => {
                        console.log("Delete category button clicked.");
                        const categoryId = event.currentTarget.dataset.id;
                        showMessage(`Bu kategoriyi silmek istediğinizden emin misiniz? <div class="flex justify-center mt-4 space-x-4"><button id="confirmDeleteCategoryBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Evet, Sil</button> <button id="cancelDeleteCategoryBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">İptal</button></div>`, 'confirm');

                        const confirmBtn = document.getElementById('confirmDeleteCategoryBtn');
                        const cancelBtn = document.getElementById('cancelDeleteCategoryBtn');

                        if (confirmBtn) confirmBtn.onclick = async () => {
                            try {
                                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                                });
                                const result = await response.json();

                                if (!response.ok) {
                                    if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                    throw new Error(result.message || 'Kategori silme başarısız oldu.');
                                }
                                showMessage(result.message, 'success');
                                fetchCategories();
                                resetCategoryForm();
                            } catch (error) {
                                console.error('Kategori silerken hata:', error);
                                showMessage(`Kategori silinirken bir hata oluştu: ${error.message}`, 'error');
                            } finally {
                                if (messageBox) messageBox.classList.add('hidden');
                            }
                        };
                        if (cancelBtn) cancelBtn.onclick = () => {
                            if (messageBox) messageBox.classList.add('hidden');
                        };
                    };
                });
            }

            function resetCategoryForm() {
                if (addCategoryInput) addCategoryInput.value = '';
                if (addCategoryTypeSelect) addCategoryTypeSelect.value = 'Genel';
                if (submitCategoryBtn) submitCategoryBtn.textContent = 'Kaydet';
                if (cancelCategoryEditBtn) cancelCategoryEditBtn.classList.add('hidden');
                if (categoryFormTitle) categoryFormTitle.textContent = 'Kategori Oluştur / Düzenle';
                editingCategoryId = null;
            }

            // Tekrarlayan İşlemler Fonksiyonları
            async function fetchRecurringTransactions() {
                try {
                    console.log("Fetching recurring transactions..."); // LOG: Tekrarlayan işlemler çekiliyor
                    const response = await fetch(`${API_BASE_URL}/recurring-transactions?userId=${userId}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    const recurringTransactions = await response.json();
                    console.log("Recurring transactions fetched:", recurringTransactions); // LOG: Tekrarlayan işlemler çekildi

                    if (recurringTransactionsListInModal) {
                        recurringTransactionsListInModal.innerHTML = '';
                        if (recurringTransactions.length === 0) {
                            recurringTransactionsListInModal.innerHTML = '<li class="text-center text-gray-500 py-2">Tekrarlayan işlem yok.</li>';
                        } else {
                            recurringTransactions.forEach(rt => {
                                const listItem = document.createElement('li');
                                const statusColor = rt.isActive ? 'text-green-600' : 'text-red-600';
                                const statusText = rt.isActive ? 'Aktif' : 'Pasif';
                                const lastProcessedDate = rt.lastProcessedAt ? new Date(rt.lastProcessedAt).toLocaleDateString('tr-TR') : 'Hiç İşlenmedi';

                                listItem.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm border border-gray-100 text-sm';
                                listItem.dataset.id = rt._id;
                                listItem.innerHTML = `
                                        <div>
                                            <p class="font-medium">${rt.name} (${rt.amount.toFixed(2)} TL - ${rt.type})</p>
                                            <p class="text-xs text-gray-500">${rt.frequency} | Son İşlem: ${lastProcessedDate} | <span class="${statusColor}">${statusText}</span></p>
                                        </div>
                                        <div>
                                            <button class="edit-recurring-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${rt._id}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="delete-recurring-btn text-red-500 hover:text-red-700" data-id="${rt._id}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    `;
                                if (recurringTransactionsListInModal) recurringTransactionsListInModal.appendChild(listItem);
                            });
                            addEventListenersToRecurringTransactionButtons();
                        }
                    } else { console.error("Recurring transactions list in modal not found!"); }

                } catch (error) {
                    console.error('Tekrarlayan işlemleri çekerken hata:', error);
                    if (recurringTransactionsListInModal) recurringTransactionsListInModal.innerHTML = '<li class="text-center text-red-500 py-2">Tekrarlayan işlemler yüklenirken hata oluştu.</li>';
                }
            }

            function resetRecurringTransactionForm() {
                if (recurringTransactionNameInput) recurringTransactionNameInput.value = '';
                if (recurringTransactionAmountInput) recurringTransactionAmountInput.value = '';
                if (recurringTransactionTypeSelect) recurringTransactionTypeSelect.value = 'Gider';
                if (recurringTransactionCategorySelect) recurringTransactionCategorySelect.value = '';
                if (recurringTransactionDescriptionInput) recurringTransactionDescriptionInput.value = '';
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                if (recurringTransactionStartDateInput) recurringTransactionStartDateInput.value = `${year}-${month}-${day}`;
                if (recurringTransactionFrequencySelect) recurringTransactionFrequencySelect.value = 'monthly';
                if (recurringTransactionIsActiveCheckbox) recurringTransactionIsActiveCheckbox.checked = true;

                if (submitRecurringTransactionBtn) submitRecurringTransactionBtn.textContent = 'Ekle';
                if (cancelRecurringTransactionEditBtn) cancelRecurringTransactionEditBtn.classList.add('hidden');
                if (recurringTransactionFormTitle) recurringTransactionFormTitle.textContent = 'Yeni Tekrarlayan İşlem Ekle';
                editingRecurringTransactionId = null;
            }

            function addEventListenersToRecurringTransactionButtons() {
                document.querySelectorAll('.edit-recurring-btn').forEach(button => {
                    button.onclick = async (event) => {
                        console.log("Edit recurring transaction button clicked.");
                        const rtId = event.currentTarget.dataset.id;
                        try {
                            const response = await fetch(`${API_BASE_URL}/recurring-transactions/${rtId}?userId=${userId}`, {
                                headers: { 'Authorization': `Bearer ${jwtToken}` }
                            });
                            if (!response.ok) {
                                if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                throw new Error(`HTTP hata! Durum: ${response.status}`);
                            }
                            const rt = await response.json();

                            if (recurringTransactionNameInput) recurringTransactionNameInput.value = rt.name;
                            if (recurringTransactionAmountInput) recurringTransactionAmountInput.value = rt.amount;
                            if (recurringTransactionTypeSelect) recurringTransactionTypeSelect.value = rt.type;
                            if (recurringTransactionCategorySelect) recurringTransactionCategorySelect.value = rt.category || '';
                            if (recurringTransactionDescriptionInput) recurringTransactionDescriptionInput.value = rt.description || '';
                            if (recurringTransactionStartDateInput) recurringTransactionStartDateInput.value = new Date(rt.startDate).toISOString().split('T')[0];
                            if (recurringTransactionFrequencySelect) recurringTransactionFrequencySelect.value = rt.frequency;
                            if (recurringTransactionIsActiveCheckbox) recurringTransactionIsActiveCheckbox.checked = rt.isActive;

                            if (submitRecurringTransactionBtn) submitRecurringTransactionBtn.textContent = 'Güncelle';
                            if (cancelRecurringTransactionEditBtn) cancelRecurringTransactionEditBtn.classList.remove('hidden');
                            if (recurringTransactionFormTitle) recurringTransactionFormTitle.textContent = 'Tekrarlayan İşlem Düzenle';
                            editingRecurringTransactionId = rtId;

                        } catch (error) {
                            console.error('Tekrarlayan işlem detaylarını çekerken hata:', error);
                            showMessage(`Tekrarlayan işlem detayları yüklenirken hata oluştu: ${error.message}`, 'error');
                        }
                    };
                });

                document.querySelectorAll('.delete-recurring-btn').forEach(button => {
                    button.onclick = async (event) => {
                        console.log("Delete recurring transaction button clicked.");
                        const rtId = event.currentTarget.dataset.id;
                        showMessage(`Bu tekrarlayan işlemi silmek istediğinizden emin misiniz? <div class="flex justify-center mt-4 space-x-4"><button id="confirmDeleteRecurringBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Evet, Sil</button> <button id="cancelDeleteRecurringBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">İptal</button></div>`, 'confirm');

                        const confirmBtn = document.getElementById('confirmDeleteRecurringBtn');
                        const cancelBtn = document.getElementById('cancelDeleteRecurringBtn');

                        if (confirmBtn) confirmBtn.onclick = async () => {
                            try {
                                const response = await fetch(`${API_BASE_URL}/recurring-transactions/${rtId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                                });
                                const result = await response.json();

                                if (!response.ok) {
                                    if (response.status === 401 || response.status === 403) { handleAuthError(); return; }
                                    throw new Error(result.message || 'Silme işlemi başarısız oldu.');
                                }
                                showMessage(result.message, 'success');
                                fetchRecurringTransactions();
                                resetRecurringTransactionForm();
                            } catch (error) {
                                console.error('Tekrarlayan işlem silerken hata:', error);
                                showMessage(`Tekrarlayan işlem silinirken bir hata oluştu: ${error.message}`, 'error');
                            } finally {
                                if (messageBox) messageBox.classList.add('hidden');
                            }
                        };
                        if (cancelBtn) cancelBtn.onclick = () => {
                            if (messageBox) messageBox.classList.add('hidden');
                        };
                    };
                });
            }

            // Sayfa Yönlendirme Butonları
            if (manageProductsBtn) {
                manageProductsBtn.addEventListener('click', () => {
                    window.location.href = 'products.html';
                    closeSidebar();
                });
            } else { console.error("Manage Products button not found!"); }

            if (viewReportsBtn) {
                viewReportsBtn.addEventListener('click', () => {
                    window.location.href = 'reports.html';
                    closeSidebar();
                });
            } else { console.error("View Reports button not found!"); }

            if (goToSalesManagementBtn) {
                goToSalesManagementBtn.addEventListener('click', () => {
                    window.location.href = 'sales_management.html';
                    closeSidebar();
                });
            } else { console.error("Go To Sales Management button not found!"); }

            // Tekrarlayan İşlemler Butonu Olay Dinleyicisi
            if (manageRecurringTransactionsBtn) {
                manageRecurringTransactionsBtn.addEventListener('click', async () => {
                    console.log("Tekrarlayan İşlemler butonu tıklandı."); // LOG: Buton tıklandı
                    if (recurringTransactionsModal) {
                        recurringTransactionsModal.classList.remove('hidden');
                        console.log("Tekrarlayan İşlemler modalı gösterildi."); // LOG: Modal gösterildi
                        resetRecurringTransactionForm(); // Formu sıfırla
                        await fetchRecurringTransactions(); // İşlemleri çek ve listele
                        closeSidebar(); // Sidebar'ı kapat
                    } else {
                        console.error("recurringTransactionsModal bulunamadı!");
                    }
                });
            } else { console.error("Manage Recurring Transactions button not found!"); }

            // Tekrarlayan İşlemler Modalı Kapatma Butonu
            if (closeRecurringTransactionsModalBtn) {
                closeRecurringTransactionsModalBtn.addEventListener('click', () => {
                    if (recurringTransactionsModal) {
                        recurringTransactionsModal.classList.add('hidden');
                        console.log("Tekrarlayan İşlemler modalı kapatıldı."); // LOG: Modal kapatıldı
                    }
                });
            } else { console.error("Close Recurring Transactions Modal button not found!"); }

            // Modala dışarı tıklayınca kapatma
            window.addEventListener('click', (event) => {
                if (event.target === recurringTransactionsModal) {
                    if (recurringTransactionsModal) {
                        recurringTransactionsModal.classList.add('hidden');
                        console.log("Tekrarlayan İşlemler modalı dış tıklama ile kapatıldı."); // LOG: Modal dış tıklama ile kapatıldı
                    }
                }
            });

            // Ay ve Yıl Dropdown'larını Doldurma Fonksiyonları
            function populateMonthYearDropdowns() {
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth(); // 0-11 arası

                if (monthSelect) {
                    monthSelect.innerHTML = '';
                    monthNames.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = month;
                        if (index === currentMonth) {
                            option.selected = true;
                        }
                        monthSelect.appendChild(option);
                    });
                } else { console.error("monthSelect not found!"); }


                if (yearSelect) {
                    yearSelect.innerHTML = '';
                    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        if (i === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    }
                } else { console.error("yearSelect not found!"); }

                if (annualYearSelect) {
                    annualYearSelect.innerHTML = '';
                    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        if (i === currentYear) {
                            option.selected = true;
                        }
                        annualYearSelect.appendChild(option);
                    }
                } else { console.error("annualYearSelect not found!"); }
            }

            // Aylık Özet Filtre Uygula Butonu
            if (applyMonthlySummaryFilterBtn) {
                applyMonthlySummaryFilterBtn.addEventListener('click', () => {
                    const selectedMonth = monthSelect ? parseInt(monthSelect.value) : new Date().getMonth();
                    const selectedYear = yearSelect ? parseInt(yearSelect.value) : new Date().getFullYear();
                    fetchMonthlySummary(selectedYear, selectedMonth);
                });
            } else { console.error("applyMonthlySummaryFilterBtn not found!"); }

            // Yıllık Özet Filtre Uygula Butonu
            if (applyAnnualSummaryFilterBtn) {
                applyAnnualSummaryFilterBtn.addEventListener('click', () => {
                    const selectedYear = annualYearSelect ? parseInt(annualYearSelect.value) : new Date().getFullYear();
                    fetchAnnualSummary(selectedYear);
                });
            } else { console.error("applyAnnualSummaryFilterBtn not found!"); }


            // Sayfa yüklendiğinde çalışacak fonksiyonlar
            initializeSidebarState();
            fetchTransactions();
            resetForm();
            fetchGeneralFinancialSummary();
            populateMonthYearDropdowns();
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            fetchMonthlySummary(currentYear, currentMonth);
            fetchAnnualSummary(currentYear);
            fetchCategories();
            fetchUser2FAStatus();
        }); // DOMContentLoaded BLOĞUNUN SONU
    </script>
</body>
</html>
